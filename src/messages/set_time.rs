use super::{Request, RequestResponseType, Response, HEADER};
use crate::messages::utils::types::DateTime;
use bincode::{Decode, Encode};

#[derive(Encode, Request)]

pub struct SetTimeRequest {
    header: u8,
    message_type: u8,
    _unused: u16,
    device_id: u32,
    datetime: DateTime,
}

impl SetTimeRequest {
    pub fn new(device_id: u32, datetime: DateTime) -> Self {
        Self {
            header: HEADER,
            message_type: RequestResponseType::SetTime.into(),
            _unused: 0,
            device_id,
            datetime,
        }
    }
}

#[test]
fn set_time_request_to_bytes() {
    let expected = [
        0x17, 0x30, 0x00, 0x00, 0x2d, 0x55, 0x39, 0x19, 0x20, 0x19, 0x04, 0x21, 0x09, 0x44, 0x40,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
    ];

    let r = SetTimeRequest::new(423187757, DateTime::new(2019, 4, 21, 9, 44, 40));

    let actual = r.to_bytes();
    assert_eq!(expected, actual);
}

#[derive(Decode, Response, Debug)]
pub struct SetTimeResponse {
    pub header: u8,
    pub message_type: u8,
    _unused: u16,
    pub device_id: u32,
    pub datetime: DateTime,
}

#[test]
fn set_time_response_from_bytes() {
    let bytes: [u8; 64] = [
        0x17, 0x32, 0x00, 0x00, 0x2d, 0x55, 0x39, 0x19, 0x20, 0x19, 0x12, 0x29, 0x12, 0x34, 0x56,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
    ];

    let r = SetTimeResponse::from_bytes(&bytes).unwrap();
    assert_eq!(r.message_type, RequestResponseType::GetTime.into());
    assert_eq!(r.device_id, 423187757);
    assert_eq!(r.datetime, DateTime::new(2019, 12, 29, 12, 34, 56));
}
